<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UVA Link Lab Publications</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .navbar {
        background-color: #d3d3d3;
        color: black;
        padding: 10px 15px;
      }

      .navbar h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      .container {
        margin-top: 20px;
        flex: 1;
      }

      .card {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        background-color: #fff;
        /* Default light mode */
        color: #333;
        /* Default light mode text color */
      }

      .card-body {
        padding: 20px;
      }

      .dark-mode .card {
        background-color: #444;
        /* Dark mode background for cards */
        color: #ddd;
        /* Dark mode text color for cards */
        border-color: #555;
        /* Dark mode border color */
      }

      .dark-mode .bibtex {
        background-color: #333;
        /* Dark mode background for BibTeX section */
        color: #ddd;
        /* Dark mode text color for BibTeX section */
        border: 1px solid #555;
        /* Dark mode border color */
      }

      /* Add a transition for smoother theme changes */
      .card,
      .bibtex {
        transition: background-color 0.3s, color 0.3s;
      }

      .filter-bar {
        margin-bottom: 20px;
      }

      .filter-bar .form-select {
        width: 100%;
        max-width: 250px;
      }

      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
      }

      .pagination {
        justify-content: center;
        margin: 0;
      }

      .pagination-container .items-per-page {
        width: 100px;
      }

      .form-select {
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        appearance: none;
      }

      .form-select-sm {
        font-size: 0.875rem;
      }

      .form-select:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .bibtex {
        display: none;
        font-family: monospace;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
      }

      .dark-mode {
        background-color: #222;
        color: #ddd;
      }

      .dark-mode .navbar,
      .dark-mode footer {
        background-color: #333;
        color: #ddd;
      }

      .dark-mode .form-select {
        color: #ddd;
        background-color: #444;
        border-color: #555;
      }

      footer {
        background-color: #d3d3d3;
        color: black;
        text-align: center;
        padding: 10px 0;
        margin-top: auto;
      }

      footer a {
        color: #0056b3;
        text-decoration: none;
      }

      .pagination-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        /* Add spacing between numbers */
        justify-content: center;
      }

      .pagination {
        flex: 1 1 auto;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div class="navbar">
      <div class="container d-flex justify-content-between align-items-center">
        <h1>UVA Link Lab Publications</h1>
        <button id="themeToggle" class="btn btn-dark btn-sm">
          Switch to Dark Mode
        </button>
      </div>
    </div>

    <div class="container">
      <!-- Filter Bar -->
      <div class="filter-bar row">
        <div class="col-md-3 mb-2">
          <input
            type="text"
            id="search"
            class="form-control"
            placeholder="Search keywords..."
          />
        </div>
        <div class="col-md-3 mb-2">
          <select id="filterAuthor" class="form-select">
            <option value="">Filter by author</option>
          </select>
        </div>
        <div class="col-md-3 mb-2">
          <select id="filterYear" class="form-select">
            <option value="">Filter by year</option>
          </select>
        </div>
        <div class="col-md-3 mb-2">
          <select id="filterJournal" class="form-select">
            <option value="">Filter by conference/journal</option>
          </select>
        </div>
      </div>

      <!-- Publication List -->
      <div id="publicationList">
        <!-- Publications will be populated dynamically -->
      </div>

      <!-- Pagination and Items Per Page -->
      <div
        class="pagination-container d-flex justify-content-between align-items-center"
      >
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item">
              <a class="page-link" href="#" id="prevPage">Previous</a>
            </li>
            <!-- Page numbers will be dynamically generated here -->
            <li class="page-item">
              <a class="page-link" href="#" id="nextPage">Next</a>
            </li>
          </ul>
        </nav>
        <div class="items-per-page">
          <select id="itemsPerPage" class="form-select form-select-sm"></select>
        </div>
      </div>
    </div>

    <footer style="margin-top: 20px">
      &copy; <span id="currentYear"></span>
      <a href="https://www.virginia.edu">University of Virginia</a>. All rights
      reserved.
    </footer>

    <script>
      let authors = [];
      let publications = [];
      let currentPage = 1;
      let itemsPerPage = 20;

      // Load authors and publications dynamically
      async function loadData() {
        const authorResponse = await fetch("authors.json");
        authors = await authorResponse.json();

        const bibResponse = await fetch("pub.bib");
        const bibText = await bibResponse.text();
        publications = parseBibTeX(bibText);

        populateFilters();
        renderPublications();
      }
      function parseBibTeX(bibText) {
        console.log("BibTeX File Content:", bibText);

        // Match all BibTeX entries with multiline support and nested braces handling
        const entries = bibText.match(/@\w+\s*{[^@]*}/gs) || [];
        console.log("Matched BibTeX Entries:", entries);

        const publications = [];

        entries.forEach((entry, index) => {
          try {
            // Extract entry type (e.g., @journalarticle)
            const typeMatch = entry.match(/^@(\w+)\s*{/i);
            const type = typeMatch ? typeMatch[1].toLowerCase() : "unknown";

            // Extract ID (e.g., @article{uniqueID,)
            const idMatch = entry.match(/@\w+\s*{([^,]+),/i);
            const id = idMatch ? idMatch[1].trim() : `entry${index}`;

            // Extract ORCID (before colon in the ID)
            const orcid = id.includes(":") ? id.split(":")[0] : null;

            // Match fields, accounting for nested braces
            const fieldRegex = /(\w+)\s*=\s*({(?:[^{}]|{[^{}]*})*})/gs;
            const fields = {};
            let match;

            while ((match = fieldRegex.exec(entry)) !== null) {
              const key = match[1].toLowerCase().trim(); // Normalize field keys
              const value = match[2].replace(/^{|}$/g, "").trim(); // Remove outer braces and trim
              fields[key] = value;
            }

            // Normalize and parse specific fields
            const authors = fields.author
              ? fields.author.split(" and ").map((author) => author.trim())
              : [];

            // Skip entries without authors
            if (!authors.length) {
              console.log(
                `Skipping entry with ID ${id} due to missing authors.`
              );
              return;
            }

            const publication = {
              id,
              orcid,
              type,
              authors,
              title: fields.title || "",
              journal: fields.journal || "",
              year: fields.year || "",
              month: fields.month || "",
              volume: fields.volume || "",
              doi: fields.doi || "",
              url: fields.url || "",
              bibtex: entry.trim(), // Preserve original BibTeX entry
            };

            publications.push(publication);

            // Log each entry
            console.log(`Parsed Entry ${index + 1}:`, publication);
          } catch (error) {
            console.error(
              `Error parsing BibTeX entry at index ${index}:`,
              error
            );
          }
        });

        console.log("Parsed Publications:", publications);
        return publications;
      }

      function populateFilters() {
        const authorSelect = document.getElementById("filterAuthor");
        const sortedAuthors = Object.entries(authors).sort(([aName], [bName]) =>
          aName.localeCompare(bName)
        );
        sortedAuthors.forEach(([name, orcid]) => {
          const option = document.createElement("option");
          option.value = orcid;
          option.textContent = name;
          authorSelect.appendChild(option);
        });

        const yearSelect = document.getElementById("filterYear");
        const years = [...new Set(publications.map((pub) => pub.year))].sort(
          (a, b) => a - b
        );
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });

        const journalSelect = document.getElementById("filterJournal");
        const journals = [...new Set(publications.map((pub) => pub.journal))]
          .filter((j) => j)
          .sort((a, b) => a.localeCompare(b));
        journals.forEach((journal) => {
          const option = document.createElement("option");
          option.value = journal;
          option.textContent = journal;
          journalSelect.appendChild(option);
        });

        populateItemsPerPage();
      }

      function populateItemsPerPage() {
        const itemsPerPageSelect = document.getElementById("itemsPerPage");
        if (!itemsPerPageSelect) {
          console.error("Dropdown for items per page not found.");
          return;
        }

        // Set a larger width for the dropdown
        itemsPerPageSelect.style.width = "115px"; // Adjust width as needed

        // Add default "Limit" option
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Limit";
        defaultOption.disabled = true; // Make it non-selectable
        defaultOption.selected = true; // Set as the default selected option
        itemsPerPageSelect.appendChild(defaultOption);

        // Add other options
        [10, 20, 30, 40, 50, 60, 70, "All"].forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          itemsPerPageSelect.appendChild(option);
        });

        itemsPerPageSelect.addEventListener("change", (e) => {
          const selected = e.target.value;
          itemsPerPage =
            selected === "All" ? publications.length : parseInt(selected, 10);
          currentPage = 1;
          renderPublications();
        });
      }

      function renderPublications() {
        const search = document
          .getElementById("search")
          .value.toLowerCase()
          .trim();
        const authorOrcid = document.getElementById("filterAuthor").value; // Selected ORCID
        const year = document.getElementById("filterYear").value;
        const journal = document.getElementById("filterJournal").value;

        // Normalize and deduplicate publications by title (case-insensitive) if no search or filters are applied
        let filteredPublications = publications.filter((pub) => {
          const matchesSearch =
            !search || JSON.stringify(pub).toLowerCase().includes(search);
          const matchesAuthor = !authorOrcid || pub.orcid === authorOrcid;
          const matchesYear = !year || pub.year == year;
          const matchesJournal = !journal || pub.journal === journal;

          return (
            matchesSearch && matchesAuthor && matchesYear && matchesJournal
          );
        });

        // Remove duplicates based on normalized title when no search or filters are applied
        if (!search && !authorOrcid && !year && !journal) {
          const seenTitles = new Set();
          filteredPublications = filteredPublications.filter((pub) => {
            const normalizedTitle = pub.title.toLowerCase().trim();
            if (seenTitles.has(normalizedTitle)) {
              return false;
            }
            seenTitles.add(normalizedTitle);
            return true;
          });
        }

        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginated = filteredPublications.slice(
          startIndex,
          startIndex + itemsPerPage
        );

        const publicationList = document.getElementById("publicationList");
        publicationList.innerHTML = paginated
          .map(
            (pub) => `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">${pub.title}</h5>
                <p class="card-text">Authors: ${pub.authors.join(", ")}, ${
              pub.year
            }</p>
                <a href="${
                  pub.url
                }" target="_blank" class="btn btn-primary">Read More</a>
                <button class="btn btn-secondary" onclick="toggleBibTeX(this)">Show BibTeX</button>
                <div class="bibtex" style="display: none;">
                    <pre>${pub.bibtex}</pre>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyBibTeX(this)">Copy BibTeX</button>
                </div>
            </div>
        </div>
    `
          )
          .join("");

        renderPagination(filteredPublications.length);
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pagination = document.querySelector(".pagination");
        pagination.innerHTML = "";

        // Add a wrapper for pagination numbers to allow multiline display
        const paginationWrapper = document.createElement("div");
        paginationWrapper.className =
          "pagination-wrapper d-flex flex-wrap justify-content-center";

        // Add "Previous" button
        const prevPage = document.createElement("li");
        prevPage.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevPage.innerHTML = `<a class="page-link" href="#">Previous</a>`;
        prevPage.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderPublications();
          }
        });
        paginationWrapper.appendChild(prevPage);

        // Add page numbers dynamically
        for (let i = 1; i <= totalPages; i++) {
          const pageItem = document.createElement("li");
          pageItem.className = `page-item ${i === currentPage ? "active" : ""}`;
          pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          pageItem.addEventListener("click", (e) => {
            e.preventDefault();
            currentPage = i;
            renderPublications();
          });
          paginationWrapper.appendChild(pageItem);
        }

        // Add "Next" button
        const nextPage = document.createElement("li");
        nextPage.className = `page-item ${
          currentPage === totalPages ? "disabled" : ""
        }`;
        nextPage.innerHTML = `<a class="page-link" href="#">Next</a>`;
        nextPage.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            renderPublications();
          }
        });
        paginationWrapper.appendChild(nextPage);

        pagination.appendChild(paginationWrapper);
      }

      // Set the current year in the copyright dynamically
      function setCurrentYear() {
        const currentYear = new Date().getFullYear();
        document.getElementById("currentYear").textContent = currentYear;
      }

      // Call the function on page load
      setCurrentYear();

      function toggleBibTeX(button) {
        const bibtex = button.nextElementSibling;
        if (!bibtex.style.display || bibtex.style.display === "none") {
          bibtex.style.display = "block";
          button.textContent = "Hide BibTeX";
        } else {
          bibtex.style.display = "none";
          button.textContent = "Show BibTeX";
        }
      }

      // Helper function to copy BibTeX content
      function copyBibTeX(button) {
        const bibtexContent = button.previousElementSibling.textContent;
        navigator.clipboard.writeText(bibtexContent).then(() => {
          alert("BibTeX copied to clipboard!");
        });
      }

      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const themeToggle = document.getElementById("themeToggle");
        themeToggle.textContent = document.body.classList.contains("dark-mode")
          ? "Switch to Light Mode"
          : "Switch to Dark Mode";
      }

      document
        .getElementById("themeToggle")
        .addEventListener("click", toggleTheme);
      document
        .getElementById("search")
        .addEventListener("input", renderPublications);
      document
        .getElementById("filterAuthor")
        .addEventListener("change", renderPublications);
      document
        .getElementById("filterYear")
        .addEventListener("change", renderPublications);
      document
        .getElementById("filterJournal")
        .addEventListener("change", renderPublications);

      loadData();
    </script>
  </body>
</html>
